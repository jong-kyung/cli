name: E2E Opportunistic Matrix

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

permissions:
  contents: read

jobs:
  matrix-e2e:
    name: Matrix (${{ matrix.scenario }})
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - react-base-pnpm
          - react-base-npm
          - solid-base-npm
          - react-template-resume
          - react-template-ecommerce
          - react-addons-core-pnpm
          - solid-addons-core-pnpm
          - react-toolchain-deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
      - name: Setup Tools
        uses: tanstack/config/.github/setup@main
      - name: Build
        run: pnpm build
      - name: Install Playwright Chrome
        run: pnpm --filter @tanstack/cli exec playwright install --with-deps chrome
      - name: Run Matrix Scenario
        env:
          E2E_MATRIX_SCENARIO: ${{ matrix.scenario }}
        run: pnpm --filter @tanstack/cli test:e2e:matrix
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.scenario }}
          path: packages/cli/playwright-report
          if-no-files-found: ignore
